# ishTools
tools I use to make life easier using iSH shell

## Available tools
### bin/apk-leaves
Displays all leaves apk, ie apks that no other apks depend upon. In order to recreate a software deploy all you need to know are the leave nodes, install them and you will have replicated your env.
Run with -h param to see options.
Should be fully generic, uses ash shell so should work on a fresh deploy.
Would probably run on any Alpine system, but I havent tried.

### bin/restore-ish
Restores an iSH env to include your prefered default state, mostly idempotent, so can be run repeatedly, for instance if you change a param, one of the tarballs it uses etc.

See the header of the file for latest changes.

Params and settings:
- time_zone if not "" This timezone will be used, format is 
Can obviously be tweaked to your needs, this is what I have it doing:

- Recognizes if this is a default or a AOK filesystem.
- Copies a few files into /etc
  - my hostfile, so it can connect to my other local devices
  - If default FS 
    - an /etc/inittab without unused gettys
    - replaces /etc/apk/repositories pointing to Alpine v3.12  
- Does apk update and apk upgrade for latest updates
- If AOK FS
  - corrects a file priv
  - removes fortune
- Adds the software I expect to be installed
- Sets my timezone
- Deploys my hostkeys if I have such for this device.
  This is a huge timesaver if you ssh into it, since otherwise after each re-install
  your other machines will complain that the hostkeys has changed.
- If activate_sshd_service is active, installs what is needed and turns on the ssh server
- Creates a no password sudo group
- If you have saved a root environ and requests it to be installed, will untar it into place
- If you have defined a username, creates it, adds it to the no-password group
- If you have saved a user environ and requests it to be installed, will untar it into place
- Checks if any patches have been defined, if so performs those actions.
  For me this is typically if I have changed a file in my homedir, but havent gotten arround to
  make a new tarball yet.
- If an extra task has been defined, run it. 
  I use this to be have my private configs outside of this repo
  I have included a sample, that deploys my local scripts and does git pull on all my locally cloned repos to ensure they are up to date.
- If a user was created and no password is yet defined, prints a reminder to set that users
  password, since otherwise you will not be able to ssh into the box.q

## Procedure to restore your environment
I deploy this to iCloud, this way I can use it on any of my devices
My procedure on a pristine iSH system (as root)
- mount -t ios . /mnt
  - Chose where this is located
- /mnt/bin/restore-ish  (takes a couple of minutes)
  If user was defined, displays a reminder to set the user password if it has not been set.
- Set the user password if requested to do so.
- Usage once restore is completed.
  - default FS
    - For local access, just do su - {your username}
    - For ssh access, reboot iSH, since sshd wont be started until next boot
, and you want to ssh in, reboot, since sshd wont be activated until you have rebooted.
  - AOK FS, you are ready to go
    - For local access just exit the current session and login as {username}
    - ssh into the device as your {username}

## My filestructure
- /apk-stats
  Every now and then I update theese, always check the date to see if it is fresh enough to be usefull for you.
This directory contains lists of all apks installed out of the box generated by apk-leaves.
This way its simple to see what is needed to get all your stuff, and what you might want to remove in your restore procedure.
- /bin The scripts included in this repo.
- /files This is where I store some files to deploy
  - inittab-default-FS -> /etc/inittab
  - hosts -> /etc/hosts
  - repositories -> /etc/apk/repositories
  - /files/tars This is where I stor home_root.tgz and home_jaclu.tgz
-  /samples This is a subset of my extra_tasks, with any more private items filtered out :)
Mostly to give you a general idea of how I use it.
- /specifics Per device items. Currently I only use it for sshd host keys, will check if there is a {hostname}-sshd_host_keys.tgz file present, sample: JacPad-sshd_host_keys.tgz
If found it will be untared it into /etc/ssh if activate_sshd_service=1

hepp

### apks-ish
For the default iSH filesystem

### apks-AOK
For the AOK filesystem


